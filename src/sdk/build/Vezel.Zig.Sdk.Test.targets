<Project>
    <ItemGroup>
        <TestAssembly Include="$(IntermediateOutputPath)$(TargetFileName).test" />
    </ItemGroup>

    <!--
    Most of the test logic in Microsoft.NET.Sdk is superfluous for our purposes,
    so we will just override the target entirely.
    -->
    <Target Name="VSTest"
            DependsOnTargets="$(VSTestDependsOn)"
            Condition="'$(CompilerMode)' == 'Zig' and '$(IsTestable)' == 'true'">
        <Message Text="Running tests natively..."
                 Importance="high"
                 Condition="'$(IsCrossExecuting)' == 'false'" />

        <ZigCompile AccessControl="$(AccessControl)"
                    BlockExtensions="$(BlockExtensions)"
                    CompilerMode="Test"
                    Configuration="$(Configuration)"
                    ConsumptionAnalysis="$(ConsumptionAnalysis)"
                    CxxExceptions="$(CxxExceptions)"
                    CxxReflection="$(CxxReflection)"
                    DebugSymbols="$(DebugSymbols)"
                    DefineConstants="$(DefineConstants)"
                    Deterministic="$(Deterministic)"
                    DisableWarnings="$(DisableWarnings)"
                    DocumentationAnalysis="$(DocumentationAnalysis)"
                    EnvironmentVariables="ZIG_GLOBAL_CACHE_DIR=$(CachePath)/global; ZIG_LOCAL_CACHE_DIR=$(CachePath)/local"
                    FastMath="$(FastMath)"
                    IncludeDirectories="@(IncludeDirectory)"
                    LanguageStandard="$(LanguageStandard)"
                    LinkTimeOptimization="$(LinkTimeOptimization)"
                    MicrosoftExtensions="$(MicrosoftExtensions)"
                    NullabilityAnalysis="$(NullabilityAnalysis)"
                    OutputBinary="@(TestAssembly)"
                    OutputType="$(OutputType)"
                    PreludeHeaders="@(PreludeHeader)"
                    PublicIncludeDirectory="$(PublicHeadersPath)"
                    ReleaseMode="$(ReleaseMode)"
                    Sanitizers="$(Sanitizers)"
                    Sources="@(Compile)"
                    SymbolExports="$(SymbolExports)"
                    SymbolVisibility="$(SymbolVisibility)"
                    TagAnalysis="$(TagAnalysis)"
                    TargetFileName="$(TargetFileName)"
                    TargetRuntimeIdentifier="$(TargetRuntimeIdentifier)"
                    TargetTriple="$(FullTargetTriple)"
                    TestFilter="$(VSTestTestCaseFilter)"
                    ThreadingAnalysis="$(ThreadingAnalysis)"
                    ToolExe="$(ZigExePath)"
                    TreatWarningsAsErrors="$(TreatWarningsAsErrors)"
                    TrustAnalysis="$(TrustAnalysis)"
                    WarningLevel="$(WarningLevel)" />

        <Message Text="Running tests with binary emulator '$(EmulatorName)'..."
                 Importance="high"
                 Condition="'$(EmulatorCommand)' != ''" />

        <Exec Command="$(EmulatorCommand) $(EmulatorArgumentPrefix)&quot;@(TestAssembly)&quot;$(EmulatorArgumentSuffix) &quot;$(ZigExePath)&quot;"
              Condition="'$(EmulatorCommand)' != ''" />

        <Message Text="A suitable binary emulator is not available for '$(HostRuntimeIdentifier)' -> '$(TargetRuntimeIdentifier)'"
                 Importance="high"
                 Condition="'$(IsCrossExecuting)' == 'true' and '$(EmulatorCommand)' == ''" />
    </Target>
</Project>
