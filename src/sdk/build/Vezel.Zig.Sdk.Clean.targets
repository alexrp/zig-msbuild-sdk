<Project>
    <ItemGroup>
        <Clean Include="$(CachePath)/**" />
        <Clean Include="$(_CommandFragmentsPath)/**" />
    </ItemGroup>

    <PropertyGroup>
        <_InnerOrOuterClean>_InnerClean</_InnerOrOuterClean>
        <_InnerOrOuterClean Condition="'$(IsOuterBuild)' == 'true'">_OuterClean</_InnerOrOuterClean>
    </PropertyGroup>

    <Target Name="Clean"
            DependsOnTargets="$(_InnerOrOuterClean)"
            Condition="'$(_InvalidConfigurationWarning)' != 'true'" />

    <Target Name="_OuterClean">
        <ItemGroup>
            <_RuntimeIdentifiers Include="$(RuntimeIdentifiers)" />
            <_InnerProjects Include="$(MSBuildProjectFullPath)"
                            Properties="RuntimeIdentifier=%(_RuntimeIdentifiers.Identity)" />
        </ItemGroup>

        <MSBuild Projects="@(_InnerProjects)"
                 Targets="_InnerClean"
                 BuildInParallel="$(BuildInParallel)" />
    </Target>

    <Target Name="_InnerClean"
            DependsOnTargets="$(CleanDependsOn)" />
</Project>
