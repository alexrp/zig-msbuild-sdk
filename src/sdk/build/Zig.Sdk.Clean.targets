<Project>
    <!--
    Ensure that we clean the Zig cache. This is particularly important since Zig
    will not recompile files that have not changed, leading to situations where
    warnings will be printed on a first build, but not on a second build.
    -->
    <ItemGroup>
        <Clean Include="$(CachePath)/**" />
    </ItemGroup>

    <PropertyGroup>
        <_RealOrFanOutClean>_InnerClean</_RealOrFanOutClean>
        <_RealOrFanOutClean Condition="'$(_BuildCleanFanOut)' == 'true'">_FanOutClean</_RealOrFanOutClean>
    </PropertyGroup>

    <Target Name="Clean"
            DependsOnTargets="$(_RealOrFanOutClean)"
            Condition="'$(_InvalidConfigurationWarning)' != 'true'" />

    <Target Name="_FanOutClean">
        <ItemGroup>
            <_RuntimeIdentifiers Include="$(RuntimeIdentifiers)" />
            <_InnerProjects Include="$(MSBuildProjectFullPath)"
                            Properties="RuntimeIdentifier=%(_RuntimeIdentifiers.Identity)" />
        </ItemGroup>

        <MSBuild Projects="@(_InnerProjects)"
                 Targets="_InnerClean"
                 BuildInParallel="$(BuildInParallel)" />
    </Target>

    <Target Name="_InnerClean"
            DependsOnTargets="$(CleanDependsOn)" />
</Project>
